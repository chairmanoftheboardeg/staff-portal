<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>EGR Staff Hub — Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root{--red:#d71920;--ink:#111;--muted:#667;--card:#fff;--line:#eee;--bg:#f6f7f9}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  header{display:flex;align-items:center;gap:12px;background:var(--red);color:#fff;padding:14px 18px}
  .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.7)}
  .grow{flex:1}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .white{background:#fff;color:var(--red)}
  main{padding:18px;display:grid;gap:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:2fr 1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
  h2{margin:.2rem 0 8px}
  h3{margin:.2rem 0 8px}
  .list{display:grid;gap:10px}
  .item{border:1px solid var(--line);border-radius:12px;padding:12px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input, textarea, select{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  .kpi{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center}
</style>
</head>
<body>
<header>
  <img id="avatar" class="avatar" alt="">
  <div class="grow">
    <div style="font-weight:900" id="name">Loading…</div>
    <div class="muted" id="meta">—</div>
  </div>
  <button class="btn white" id="logout">Logout</button>
</header>

<main>
  <section class="grid">
    <div class="card">
      <h2>Welcome</h2>
      <p class="muted">This is your staff dashboard. Access schedules, documents, and announcements.</p>

      <div class="kpis" style="margin-top:12px">
        <div class="kpi"><div style="font-weight:900;font-size:22px" id="k_open">0</div><div class="muted">Open Announcements</div></div>
        <div class="kpi"><div style="font-weight:900;font-size:22px" id="k_warn">0</div><div class="muted">Active Warnings</div></div>
        <div class="kpi"><div style="font-weight:900;font-size:22px" id="k_docs">12</div><div class="muted">Docs</div></div>
        <div class="kpi"><div style="font-weight:900;font-size:22px" id="k_me">—</div><div class="muted">Your Tasks</div></div>
      </div>

      <h3 style="margin-top:18px">Announcements</h3>
      <div id="annList" class="list"></div>
    </div>

    <div class="card" id="adminPanel" style="display:none">
      <h2>Admin Console</h2>
      <p class="muted">HR & Executive tools. Actions here are saved to your browser (demo). For shared persistence we can add a backend later.</p>

      <h3 style="margin-top:8px">New Announcement</h3>
      <div class="row">
        <input id="annTitle" placeholder="Title">
        <textarea id="annBody" placeholder="Message" rows="3"></textarea>
        <button class="btn" style="background:var(--red);color:#fff" id="postAnn">Post</button>
      </div>

      <h3 style="margin-top:14px">Issue Warning</h3>
      <div class="row">
        <input id="warnUser" placeholder="User email (e.g. ash@flydubai)">
        <select id="warnLevel">
          <option value="Notice">Notice</option>
          <option value="Warning">Warning</option>
          <option value="Final">Final</option>
        </select>
        <input id="warnReason" placeholder="Reason">
        <button class="btn" style="background:var(--red);color:#fff" id="issueWarn">Issue</button>
      </div>

      <h3 style="margin-top:14px">Warnings</h3>
      <div id="warnList" class="list"></div>
    </div>
  </section>
</main>

<script src="/js/users.js"></script>
<script>
// Auth gate
const me = window.EGR_AUTH.me();
if (!me) { location.href = "index.html"; }

// Fill header
document.getElementById('name').textContent = me.full_name || me.email;
document.getElementById('meta').textContent = `${me.role || 'Staff'} • ${me.department || '-'}`;
if (me.avatar_url) document.getElementById('avatar').src = me.avatar_url;
document.getElementById('logout').onclick = ()=>{ window.EGR_AUTH.logout(); location.href="index.html"; };

// Simple localStorage stores (demo)
const ANN_KEY = "egr_announcements";
const WARN_KEY = "egr_warnings";

function loadJSON(k, fallback) {
  try { return JSON.parse(localStorage.getItem(k) || "null") ?? fallback; }
  catch { return fallback; }
}
function saveJSON(k, v) {
  localStorage.setItem(k, JSON.stringify(v));
}

// Announcements
function renderAnnouncements(){
  const list = document.getElementById('annList');
  const items = loadJSON(ANN_KEY, []);
  document.getElementById('k_open').textContent = items.length;
  if (!items.length) { list.innerHTML = `<div class="item muted">No announcements yet.</div>`; return; }
  list.innerHTML = items.map((a,i)=>`
    <div class="item">
      <div class="row" style="justify-content:space-between">
        <strong>${a.title}</strong>
        ${me.is_admin ? `<button class="btn" onclick="delAnn(${i})">Delete</button>` : ``}
      </div>
      <div class="muted" style="font-size:.9rem">By ${a.by} • ${new Date(a.ts).toLocaleString()}</div>
      <div style="margin-top:6px">${a.body.replace(/\n/g,'<br>')}</div>
    </div>
  `).join('');
}
window.delAnn = function(i){
  if (!me.is_admin) return;
  const items = loadJSON(ANN_KEY, []);
  items.splice(i,1); saveJSON(ANN_KEY, items); renderAnnouncements();
}

if (me.is_admin) {
  document.getElementById('adminPanel').style.display = "";
  document.getElementById('postAnn').onclick = ()=>{
    const t = document.getElementById('annTitle').value.trim();
    const b = document.getElementById('annBody').value.trim();
    if (!t || !b) return;
    const items = loadJSON(ANN_KEY, []);
    items.unshift({ title: t, body: b, by: me.full_name || me.email, ts: Date.now() });
    saveJSON(ANN_KEY, items);
    document.getElementById('annTitle').value = "";
    document.getElementById('annBody').value = "";
    renderAnnouncements();
  };

  // Warnings
  function renderWarnings(){
    const list = document.getElementById('warnList');
    const items = loadJSON(WARN_KEY, []);
    document.getElementById('k_warn').textContent = items.length;
    if (!items.length) { list.innerHTML = `<div class="item muted">No warnings.</div>`; return; }
    list.innerHTML = items.map((w,i)=>`
      <div class="item">
        <div class="row" style="justify-content:space-between">
          <strong>${w.level}</strong>
          <button class="btn" onclick="delWarn(${i})">Delete</button>
        </div>
        <div class="muted" style="font-size:.9rem">${w.user} • ${new Date(w.ts).toLocaleString()} • By ${w.by}</div>
        <div style="margin-top:6px">${w.reason}</div>
      </div>
    `).join('');
  }
  window.delWarn = function(i){
    const items = loadJSON(WARN_KEY, []);
    items.splice(i,1); saveJSON(WARN_KEY, items); renderWarnings();
  };

  document.getElementById('issueWarn').onclick = ()=>{
    const user = document.getElementById('warnUser').value.trim();
    const level = document.getElementById('warnLevel').value;
    const reason = document.getElementById('warnReason').value.trim();
    if (!user || !reason) return;
    const items = loadJSON(WARN_KEY, []);
    items.unshift({ user, level, reason, by: me.full_name || me.email, ts: Date.now() });
    saveJSON(WARN_KEY, items);
    document.getElementById('warnUser').value = "";
    document.getElementById('warnReason').value = "";
    renderWarnings();
  };

  renderWarnings();
}

// Personal tasks demo number
document.getElementById('k_me').textContent = Math.floor(Math.random()*4)+1;

// Initial render
renderAnnouncements();
</script>
</body>
</html>