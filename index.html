<script>
const API = "PASTE_YOUR_APPS_SCRIPT_EXEC_URL_HERE"; // <- /exec URL
const $ = s => document.querySelector(s);

function jsonp(method, params={}, onDone){
  const cb = "cb_" + Math.random().toString(36).slice(2);
  window[cb] = (resp)=>{ try{ onDone(resp); } finally{ delete window[cb]; } };
  const q = new URLSearchParams({ method, callback: cb, ...params });
  const s = document.createElement("script");
  s.src = API + "?" + q.toString();
  s.onerror = ()=> onDone({ ok:false, error:"Network/blocked (check Apps Script deployment)" });
  document.body.appendChild(s);
}

async function sha256(s){
  const enc = new TextEncoder().encode(s);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function login(){
  const email = $("#email").value.trim();
  const pass  = $("#pass").value;
  $("#msg").textContent = "";
  if(!email || !pass){ $("#msg").textContent = "Enter email & password"; return; }
  const password_hash = await sha256(pass);

  jsonp("login", { email, password_hash }, (r)=>{
    if(!r || !r.ok){ $("#msg").textContent = "❌ " + (r?.error || "Network error — check Apps Script URL"); return; }
    localStorage.setItem("egr_token", r.token);
    localStorage.setItem("egr_profile", JSON.stringify(r.profile));
    location.href = "dashboard.html";
  });
}

document.getElementById("loginBtn").onclick = login;
["email","pass"].forEach(id => {
  document.getElementById(id).addEventListener("keydown", e => { if(e.key==="Enter"){e.preventDefault();login();} });
});
</script>